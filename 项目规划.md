# 项目规划

## 一、项目简介

本项目为网页端音乐疗愈游戏，用户可在不同场景中移动人物，收集声音元素，并在声音库中自由混音创作音乐。游戏注重治愈体验与互动性，适合各年龄段用户。

---

## 二、技术选型（Next.js一体化方案）

### 前端&后端一体化
- **Next.js**：实现前后端一体化开发，支持页面路由、API接口、静态资源管理。
- **React**：作为Next.js的基础，组件化开发，适合复杂交互。
- **Framer Motion/GSAP**：动画实现。
- **Howler.js + Web Audio API**：音频播放与混音。
- **react-dnd/react-beautiful-dnd**：拖拽交互。
- **Redux Toolkit/React Context**：状态管理。
- **styled-components/Tailwind CSS**：样式。

### Next.js优势说明
- 前后端一体化，API接口可直接在`/pages/api`目录下编写，便于作品保存、分享等后端功能。
- 静态资源统一管理，素材可直接放在`/public`目录，前端可直接访问。
- 内置路由系统，支持多页面和动态路由，便于实现关卡选择、场景、分享等页面。
- 支持SSR/SSG，提升首屏加载速度和SEO（如分享页）。
- 易于部署，Vercel/Netlify等平台原生支持。

---

## 三、核心功能模块

1. **地图与人物移动**
   - 地图为大图，支持点击移动人物（gif动画）。
   - 人物靠近声音元素触发对话动画。
2. **声音元素**
   - 图标+音频，分布在地图各处，靠近后可收集。
3. **对话动画**
   - gif或序列帧动画，支持文本气泡。
4. **声音库与混音**
   - 展示已收集声音元素，支持拖拽混音、试听、保存、分享。
5. **作品保存与分享**
   - 通过Next.js API路由实现本地或后端存储，生成分享链接。

---

## 四、地图切换与主界面UI/交互逻辑

### 1. 关卡选择界面
- 展示所有可选关卡（如"魔法森林"），每个关卡有配图、标题、简介。
- 左右切换按钮浏览不同关卡，点击"开始探索"进入场景。

### 2. 进入具体场景
- 人物初始在左侧，声音元素分布在场景中。
- 场景背景为大图或分层图片。

### 3. 主场景界面UI布局
- 顶部功能区：
  - 左上"声音背包"：弹出面板展示已收集声音元素，点击可播放。
  - 右上"任务提示"：弹窗展示收集进度与引导。
  - 右上"设置"：弹窗，包含音量调节、退出等。
- 场景区：
  - 背景、人物、声音元素分布。

### 4. 交互流程
1. 进入游戏 → 关卡选择界面。
2. 选择关卡并开始探索 → 加载场景。
3. 人物初始在左侧，点击场景任意位置移动。
4. 靠近声音元素，触发对话动画，动画结束后可收集。
5. 收集到的声音元素进入"声音背包"，可随时查看和试听。
6. 右上角任务提示实时展示收集进度。
7. 右上角设置可调节音量、退出等。

---

## 五、项目结构建议（Next.js版）

```
/public
  /assets
    /characters  // 人物gif
    /scenes      // 地图场景和场景元素
    /sounds      // 声音元素图标和mp3
    /dialogs     // 对话动画
/src
  /components
    MapScene.jsx
    Character.jsx
    SoundElement.jsx
    DialogAnimation.jsx
    SoundLibrary.jsx
    Mixer.jsx
    SaveSharePanel.jsx
  /hooks
  /utils
  /store
/pages
  index.tsx         // 关卡选择页
  scene/[id].tsx    // 场景页面，支持动态路由
  share/[id].tsx    // 作品分享页
  /api
    save.ts         // 保存作品API
    share.ts        // 分享API
/README.md
```

---

## 六、组件划分建议

- `LevelSelector` 关卡选择页
- `Scene` 场景主界面
- `Character` 人物动画
- `SoundElement` 声音元素
- `SoundBag` 声音背包弹窗
- `TaskHint` 任务提示弹窗
- `Settings` 设置弹窗
- `TopBar` 顶部功能区

---

## 七、状态管理
- 当前关卡、场景数据
- 人物位置
- 已收集声音元素
- 当前任务进度
- 设置项（音量等）

---

## 八、关键技术点说明
- 人物移动：点击场景后，计算目标坐标，平滑移动。
- 声音元素分布：用配置文件定义每个关卡的声音元素坐标、资源。
- 弹窗管理：用React Portal或条件渲染实现。
- 音频播放：Howler.js管理声音播放，支持多音轨、音量调节。
- 进度提示：实时根据已收集数量/总数更新。
- API路由：Next.js `/pages/api` 目录下实现后端接口，前端通过fetch调用。

---

## 九、可扩展方向
- 增加关卡、任务系统
- 支持自定义上传声音
- 多人协作混音
- 移动端适配

---

## 十、JSDoc注释规范
所有核心函数、组件、关键状态、交互事件、API接口都应加上JSDoc注释，便于后期维护和协作。

---

## /assets/scenes 文件夹说明

`/assets/scenes` 用于存放每个地图场景的相关素材，具体包括：

1. **场景背景图**
   - 每个关卡/场景有一张主背景图（如森林、湖泊等），用于渲染场景基础画面。
   - 命名建议：`scene_关卡名_bg.png`。

2. **场景元素（gif动画）**
   - 每个场景分布有若干"场景元素"，如树下的火焰、风吹草动等。
   - 每个场景元素为一个gif动画（如`fire.gif`），用于表现动态效果。
   - 命名建议：`scene_关卡名_元素名.gif`。

3. **声音元素（与场景元素一一对应）**
   - 每个场景元素对应一个声音元素，包括：
     - 图标（ico/png）：如`fire.png`，用于拾取界面和背包展示。
     - 音频（mp3）：如`fire.mp3`，用于混音和试听。
   - 命名建议：`scene_关卡名_元素名.png`、`scene_关卡名_元素名.mp3`。

4. **动画与声音元素的触发逻辑**
   - 只有当人物靠近某个gif场景元素时，才会触发该元素的动画播放。
   - 动画播放完毕后，界面上展示对应的声音元素（如右图所示，出现带有音乐符号的光球）。
   - 用户点击声音元素，即可将其收集到声音背包。

5. **素材组织建议**
   - 每个场景可建独立子文件夹，便于管理：
     ```
     /assets/scenes/
       /forest/
         bg.png
         fire.gif
         fire.png
         fire.mp3
         wind.gif
         wind.png
         wind.mp3
       /lake/
         ...
     ```

6. **示例流程**
   - 进入场景后，人物可自由移动。
   - 靠近如"火焰"场景元素时，自动播放`fire.gif`动画。
   - 动画结束后，出现"火焰"声音元素（如带音乐符号的光球），点击后收集到背包。

---

## 人物移动与朝向表现

1. **人物动画资源**
   - 人物为单独的gif动画资源，默认面向右侧。

2. **移动方向与镜像处理**
   - 当用户点击屏幕左侧，人物向左移动时，使用CSS的`transform: scaleX(-1)`对gif进行水平镜像，表现人物面向左。
   - 向右移动时，直接使用原始gif。
   - 这样只需一套gif资源即可实现自然的左右移动动画。

3. **实现建议（以React为例）**
   ```jsx
   /**
    * 人物组件
    * @param {string} gifSrc - gif图片路径
    * @param {boolean} faceLeft - 是否朝左
    */
   function Character({ gifSrc, faceLeft }) {
     return (
       <img
         src={gifSrc}
         alt="character"
         style={{
           width: '120px',
           height: 'auto',
           transform: faceLeft ? 'scaleX(-1)' : 'none',
           transition: 'transform 0.2s'
         }}
       />
     );
   }
   ```

4. **注意事项**
   - 仅适用于无方向性内容的gif（如无文字、无特殊标志）。
   - 若gif中有不对称元素，需美术提前规避。

---

## 项目进展与阶段目标

### 当前进展总结
1. **项目初始化**：已完成 Next.js + TypeScript 项目初始化。
2. **依赖安装**：已安装 howler、framer-motion、react-dnd、styled-components、@reduxjs/toolkit、react-redux 等核心依赖。
3. **目录结构**：已自动创建 public/assets、src/components、src/store、src/hooks、src/utils 及 pages 相关目录。
4. **基础组件**：已生成 MapScene、Character、SoundElement、DialogAnimation、SoundLibrary、Mixer、SaveSharePanel 等基础组件文件。
5. **页面文件**：已生成关卡选择页、场景页、分享页及API接口基础文件。
6. **Redux Store**：已自动生成全局 store 及 level、scene、character、soundBag、mixer、task、settings 等核心 slice。
7. **全局状态注入**：已在 _app.tsx 中完成 Redux Provider 包裹。
8. **JSDoc注释**：所有核心文件均带有JSDoc注释，便于维护和协作。

### 阶段开发目标

#### 第一阶段：基础功能开发
- [ ] 关卡选择页（LevelSelector）UI与交互实现
- [ ] 场景主界面（Scene）基础布局与地图渲染
- [ ] 人物移动与朝向切换逻辑实现
- [ ] 声音元素分布与靠近触发动画、收集逻辑
- [ ] 声音背包（SoundBag）展示与试听功能
- [ ] 任务提示与设置弹窗基础功能

#### 第二阶段：混音与作品管理
- [ ] 混音区（Mixer）拖拽、试听与音量调整
- [ ] 作品保存与分享功能（API对接）
- [ ] 分享页作品回显与试听

#### 第三阶段：体验优化与扩展
- [ ] 动画与音效细节优化
- [ ] 适配移动端与响应式布局
- [ ] 关卡/任务扩展与自定义
- [ ] 代码重构与性能优化

> 阶段目标可根据实际开发进度动态调整，建议每完成一阶段及时总结与复盘。 